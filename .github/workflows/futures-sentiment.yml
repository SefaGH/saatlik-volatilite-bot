name: Futures Sentiment Notifier

on:
  schedule:
    - cron: '15 * * * *'   # every hour at minute 15 (UTC)
  workflow_dispatch: {}

jobs:
  run-futures-sentiment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: |
          python -m pip install --upgrade pip
          pip install requests
      - name: Run Futures Sentiment check
        run: |
          python - <<'EOF'
          import os, requests, datetime

          TELEGRAM_BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
          TELEGRAM_CHAT_ID = os.environ["TELEGRAM_CHAT_ID"]

          def send(msg):
              url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
              requests.post(url, json={"chat_id": TELEGRAM_CHAT_ID, "text": msg, "parse_mode": "HTML"})

          try:
              # Binance Futures API - Global Long/Short Accounts Ratio (1h interval, last point)
              url_acc = "https://fapi.binance.com/futures/data/globalLongShortAccountRatio?period=1h&limit=1"
              acc = requests.get(url_acc, timeout=30).json()
              ratio_acc = float(acc[0]['longShortRatio'])
              long_pct_acc = 100 * ratio_acc / (1 + ratio_acc)
              short_pct_acc = 100 - long_pct_acc

              # Binance Futures API - Taker Volume Long/Short Ratio (1h)
              url_vol = "https://fapi.binance.com/futures/data/takerlongshortRatio?period=1h&limit=1"
              vol = requests.get(url_vol, timeout=30).json()
              ratio_vol = float(vol[0]['buySellRatio'])
              long_pct_vol = 100 * ratio_vol / (1 + ratio_vol)
              short_pct_vol = 100 - long_pct_vol

              # Mesaj formatÄ±
              trend = "NEUTRAL â¸ï¸"
              if long_pct_acc > 55 and long_pct_vol > 55:
                  trend = "LONG aÄŸÄ±rlÄ±klÄ± âœ…"
              elif short_pct_acc > 55 and short_pct_vol > 55:
                  trend = "SHORT aÄŸÄ±rlÄ±klÄ± âŒ"

              msg = (
                  "ğŸ“Š <b>Binance Futures Global Sentiment (1h)</b>\n"
                  f"- Accounts Ratio: {ratio_acc:.2f} ({long_pct_acc:.1f}% long / {short_pct_acc:.1f}% short)\n"
                  f"- Volume Ratio: {ratio_vol:.2f} ({long_pct_vol:.1f}% long / {short_pct_vol:.1f}% short)\n"
                  f"- EÄŸilim: {trend}"
              )
              send(msg)
          except Exception as e:
              send(f"âŒ Futures Sentiment Error: {e}")
          EOF
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
